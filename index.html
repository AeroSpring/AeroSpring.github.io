<head>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas></canvas>
  <div id="dom-overlay">
    <div id="gizmo-block">
      <span id="move_icon" class="material-icons-outlined">open_with</span>
      <span id="rotate_icon" class="material-icons-outlined">autorenew</span>
      <span id="close_icon" class="material-icons-outlined">cancel</span> 
    </div>

  </div>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>
  <script>

    // ИЗВЛЕЧЕНИЕ ТЕГОВ ИЗ РАЗМЕТКИ
    let canvas = window.document.querySelector('canvas');
    let domOverlay = window.document.querySelector('#dom-overlay');

    // СОЗДАНИЕ ДВИЖКА
    let engine = new BABYLON.Engine(canvas);

    // СОЗДАНИЕ СЦЕНЫ И ПРИСОЕДИНЕНИЕ ЕЁ К ДВИЖКУ
    let scene = new BABYLON.Scene(engine);
    scene.createDefaultEnvironment({
      createSkybox: false,
      createGround: false
    });

    // СОЗДАНИЕ СВЕТА
    let light = new BABYLON.PointLight('light', new BABYLON.Vector3(10, 10, -2), scene);
    light.intensity = 0.7;

    // ПОДКЛЮЧЕНИЕ WEBXR
    let xr = await scene.createDefaultXRExperienceAsync({
      uiOptions: {
        sessionMode: 'immersive-ar',
        referenceSpaceType: 'local-floor',
      }
    });
    let xrCamera = xr.baseExperience.camera;

    // ПОДКЛЮЧЕНИЕ DOM OVERLAY
    let featuresManager = xr.baseExperience.featuresManager;
    featuresManager.enableFeature(BABYLON.WebXRDomOverlay, 'latest', {element: '#dom-overlay'}, undefined, false);
    // ОТОБРАЖЕНИЕ DOM OVERLAY, ПОСЛЕ ПЕРЕХОДА В XR-РЕЖИМ
    xr.baseExperience.onStateChangedObservable.add((webXRState)=>{
      domOverlay.style.display = 'block';
      /*
      switch(webXRState){
        case BABYLON.WebXRState.IN_XR: {
          domOverlay.style.display = 'block';
          break;
        }
        case BABYLON.WebXRState.EXITING_XR: {
          domOverlay.style.display = 'none';
          break;
        }
        default: break;
      }
      */
    });



    //ЗАГРУЗКА 3D-МОДЕЛИ
    BABYLON.SceneLoader.ImportMesh(
      null, 
      'assets/drone/', 
      'drone.glb', 
      scene, 
      (meshArray) => {
        let drone = meshArray[0];
        drone.scaling = new BABYLON.Vector3(0.5, 0.5, 0.5);
        drone.position = new BABYLON.Vector3(-1, 1, 4);
        shadowGenerator.addShadowCaster(drone); //отбрасываемая тень
        drone.receiveShadows = true; //принимаемая тень

      }
    );

    BABYLON.SceneLoader.ImportMesh(
      null, 
      'assets/steampunk/', 
      'steampunk.glb', 
      scene, 
      (meshArray) => {
        let steampunk = meshArray[0];
        steampunk.scaling = new BABYLON.Vector3(0.15, 0.15, 0.15);
        steampunk.position = new BABYLON.Vector3(1, 1, 1);
        steampunk.rotation = new BABYLON.Vector3(0, 90, 0);
        shadowGenerator.addShadowCaster(steampunk); //отбрасываемая тень
        steampunk.receiveShadows = true; //принимаемая тень

      }
    );



    engine.runRenderLoop(() => scene.render());


    
    // ОБРАБОТЧИКИ СОБЫТИЙ
    drone.addEventListener('input', (event) => {
      //drone.isVisible = false;
      drone.dispose();
      //drone.scaling = new BABYLON.Vector3(0.75, 0.75, 0.75);
    });


    /*
    drone.actionManager = new BABYLON.ActionManager(scene);
    drone.actionManager.registerAction(
      new BABYLON.ExecuteCodeAction(
        BABYLON.ActionManager.OnPickTrigger, function () {
          drone.isVisible = false;
          //drone.dispose();
          //drone.scaling = new BABYLON.Vector3(0.75, 0.75, 0.75);
        }
      )
    );
    */

    /*
    steampunk.actionManager = new BABYLON.ActionManager(scene); // Создаем ActionManager для меша
    steampunk.actionManager.registerAction(
      new BABYLON.ExecuteCodeAction(
        {trigger: BABYLON.ActionManager.OnPickTrigger}, // Тип события: клик по мешу
        function () {
          //steampunk.isVisible = false;
          //alert("Вы жмакнули по steampunk"); // Действие при клике
          //steampunk.dispose();
          steampunk.scaling = new BABYLON.Vector3(0.1, 0.1, 0.1);
        },
      ),
    );
    */
    
    

  </script>
</body>