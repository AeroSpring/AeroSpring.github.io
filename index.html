<head>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <canvas></canvas>
  <div id="dom-overlay">
    <div id="gizmo-block">
    </div>
  </div>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
  <script type="module">
    
    // ИЗВЛЕЧЕНИЕ ТЕГОВ ИЗ РАЗМЕТКИ
    let canvas = window.document.querySelector('canvas');
    let domOverlay = window.document.querySelector('#dom-overlay');
    let gizmoBlock = window.document.querySelector('#gizmo-block');
    
    // СОЗДАНИЕ ДВИЖКА
    let engine = new BABYLON.Engine(canvas);
    
    // СОЗДАНИЕ СЦЕНЫ И ПРИСОЕДИНЕНИЕ ЕЁ К ДВИЖКУ
    let scene = new BABYLON.Scene(engine);
    scene.createDefaultEnvironment({
      createSkybox: false,
      createGround: false
    });
    
    // СОЗДАНИЕ СВЕТА
    let light = new BABYLON.PointLight('light', new BABYLON.Vector3(10, 10, -2), scene);
    light.intensity = 0.7;

    // ПОДКЛЮЧЕНИЕ WEBXR
    scene.createDefaultXRExperienceAsync({
      uiOptions: {
        sessionMode: 'immersive-ar', 
        referenceSpaceType: 'local-floor',
      }
    });
    
    // ПОДКЛЮЧЕНИЕ GIZMO
    let gizmoManager = new BABYLON.GizmoManager(scene);



    // ПЕРЕМЕННЫЕ
    //let activeElement = null;
    let editingElement = null;



    // ФУНКЦИИ
    // ФУНКЦИИ ДЛЯ GIZMO
    const clearGizmoOptions = () => {
      gizmoManager.positionGizmoEnabled = false;
      gizmoManager.boundingBoxGizmoEnabled = false;
    }

    const setGizmoOption = (option) => {
      clearGizmoOptions(true);
      switch(option) {
        case 'dispose': {
          //window.location = 'https://okru.ru/userpubl/aerospring';
          document.location.href = 'https://okru.ru/userpubl/aerospring';
          closeGizmo(true)
          break;
        }
        case 'move': {
          moveIcon.style.color = 'white';
          gizmoManager.positionGizmoEnabled = true;
          break;
        }
        default: break;
      }
    }

    const closeGizmo = (needDispose = false) => {
      clearGizmoOptions();
      gizmoManager._attachedMesh = null;
      gizmoManager.enableAutoPicking = true;
      gizmoBlock.style.display = 'none';
      (needDispose)
        ? editingElement.dispose()
        : editingElement = null;
    }



    // ДОБАВЛЕНИЕ МОДЕЛЕЙ
    BABYLON.SceneLoader.ImportMesh(
      null, 
      'assets/drone/', 
      'drone.glb', 
      scene, 
      (meshArray) => {
        let droneMesh = meshArray[0];
        droneMesh.scaling = new BABYLON.Vector3(0.5, 0.5, 0.5);
        droneMesh.position = new BABYLON.Vector3(-1, 1, 4);
        shadowGenerator.addShadowCaster(droneMesh); //отбрасываемая тень
        droneMesh.receiveShadows = true; //принимаемая тень
      }
    );

    BABYLON.SceneLoader.ImportMesh(
      null, 
      'assets/steampunk/', 
      'steampunk.glb', 
      scene, 
      (meshArray) => {
        let steampunkMesh = meshArray[0];
        steampunkMesh.scaling = new BABYLON.Vector3(0.15, 0.15, 0.15);
        steampunkMesh.position = new BABYLON.Vector3(1, 1, 1);
        steampunkMesh.rotation = new BABYLON.Vector3(0, 90, 0);
        shadowGenerator.addShadowCaster(steampunkMesh); //отбрасываемая тень
        steampunkMesh.receiveShadows = true; //принимаемая тень
      }
    );



    engine.runRenderLoop(() => scene.render());



    // ОБРАБОТЧИКИ СОБЫТИЙ
    // ОБРАБОТЧИКИ СОБЫТИЙ ДЛЯ GIZMO
    gizmoManager.onAttachedToMeshObservable.add((mesh) => {
      //gizmoManager.enableAutoPicking = false;
      editingElement = mesh;
      //gizmoBlock.style.display = 'block';
      setGizmoOption('dispose');

      /*
      if(!activeElement){
        gizmoManager.enableAutoPicking = false;
        editingElement = mesh;
        gizmoBlock.style.display = 'block';
        setGizmoOption('move');
      }else{
        gizmoManager._attachedMesh = null;
      }
      */
    });

    //moveIcon.addEventListener('click', (event) => setGizmoOption('move'));

  </script>
</body>